<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CHARCUTERIA FERIA DEL ESTE </title>
    <!-- Incluye el CDN de Tailwind CSS para un diseño moderno -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Incluye la librería para generar códigos QR -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
       /*<span style="font-family: 'Courier New', monospace;">Your text here</span>

       
       /* body { font-family: Consolas, Monaco, 'Lucida Console', monospace; }

        /* Aquí se importa la nueva fuente 'Blinker' de Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Blinker:wght@400;600;700;900&display=swap');
        /* Nueva fuente para la animación */
        @import url('https://fonts.googleapis.com/css2?family=Staatliches&display=swap');
        /* Nueva fuente para el contador digital */
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@900&display=swap');
        
        body {
         /* CAMBIO REALIZADO: Se aplica la fuente 'Inter' y un fondo oscuro */
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Tono oscuro elegante */
            touch-action: pan-x pan-y;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -webkit-overflow-scrolling: touch;
            overflow: hidden;
            height: 100vh;
        }

        /* Contenedor principal para que ocupe todo el espacio y esté centrado */
        .container-full {
            width: 100%;
            max-width: none;
        }
        
        /* Estilo para el elemento de producto seleccionado con el teclado */
        .highlighted {
            background-color: #4a5568 !important; /* Un gris más oscuro para resaltar */
        }
        /* Estilo para la ventana modal de vista previa */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6); /* Fondo semi-transparente más oscuro */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #2d3748; /* Fondo oscuro para modales */
            color: #e2e8f0; /* Texto claro para modales */
            padding: 24px;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
        }
        /* Oculta elementos al imprimir para una mejor presentación */
        @media print {
            body {
                background-color: #fff;
            }
            .no-print {
                display: none !important;
            }
            #printOnlyContent {
                display: block !important;
                background-color: #fff !important;
            }
            .print-list-item {
                 background-color: transparent !important;
                 box-shadow: none !important;
                 border: none !important;
            }
        }
        /* Estilo específico para la ventana modal de la calculadora */
        #calculatorModal .modal-content {
            max-width: 350px;
        }
        .calculator-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }
        .calculator-button {
            background-color: #4a5568;
            color: #e2e8f0;
            font-weight: 600;
            padding: 16px;
            border-radius: 9999px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .calculator-button:hover {
            background-color: #718096;
        }
        .calculator-button.operator {
            background-color: #4f46e5; /* Indigo para operadores */
            color: white;
        }
        .calculator-button.operator:hover {
            background-color: #6366f1;
        }
        .calculator-button.equals {
            grid-column: span 2;
        }
        
        /* Nuevo estilo para la mini-modal de unidades */
        #unitModal .modal-content {
            max-width: 300px;
            text-align: center;
        }
        .unit-button {
            background-color: #4f46e5;
            color: white;
            padding: 12px 24px;
            border-radius: 9999px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            display: block;
            margin-bottom: 12px;
        }
        .unit-button:hover {
            background-color: #6366f1;
        }
        /* Clase para resaltar las opciones de la unidad */
        .unit-option-highlighted {
            background-color: #4338ca; /* Un indigo más oscuro */
            border: 2px solid #a5b4fc; /* Borde claro para mayor visibilidad */
        }
        
        /* Estilos para la nueva modal de opciones */
        #optionsModal .modal-content {
            width: 280px;
            max-width: 90%;
            text-align: center;
            background-color: #1a202c;
            border: 1px solid #4a5568;
            border-radius: 1rem;
            color: #e2e8f0;
        }
        
        .option-button {
            background-color: transparent;
            color: #e2e8f0; /* Texto claro */
            padding: 12px;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            width: 100%;
            text-align: left;
        }
        .option-button:hover {
            background-color: #4a5568;
        }
        .option-button svg {
            margin-right: 8px;
            height: 20px;
            width: 20px;
        }
        
        /* Estilo para el nuevo contador digital (ya es oscuro, encaja bien) */
        .digital-counter {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.5rem;
            background-color: #080c10;
            color: #00e5ff;
            text-shadow: 0 0 4px #00e5ff, 0 0 8px #00e5ff, 0 0 12px #2575fc;
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid #00e5ff;
            box-shadow: 0 0 10px rgba(0, 229, 255, 0.4) inset, 0 0 5px rgba(0, 229, 255, 0.3);
            min-width: 60px;
            text-align: center;
        }
        
        /* Estilos para el contenedor de impresión, oculto por defecto */
        #printOnlyContent {  
            display: none;
            width: 100%;
        }
        /* Estilos para el modal del QR */
        #qrModal .modal-content {
            max-width: 350px;
            text-align: center;
        }

        /* ===== INICIO: CSS ACTUALIZADO PARA ANIMACIÓN ===== */
        .animated-title-container {
            position: fixed;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'Staatliches', sans-serif;
            font-size: 3rem;
            color: #cbd5e1; /* Color de texto claro */
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7); /* Sombra para resaltar en fondo oscuro */
            pointer-events: none;
            z-index: 2000;
        }

        .animated-title-container span {
            opacity: 0;
            position: relative;
            display: inline-block;
            animation: runInAndOut 18s infinite cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        /* Keyframes para la animación de "correr" de cada letra */
        @keyframes runInAndOut {
            /* FASE 1: Entra corriendo (0% a 3.5%) */
            0% {
                opacity: 0;
                transform: translateX(-80px) rotate(-10deg);
            }
            /* Overshoot */
            2.1% {
                opacity: 1;
                transform: translateX(10px) rotate(3deg);
            }
            /* Settle */
            3.5% {
                opacity: 1;
                transform: translateX(0) rotate(0deg);
            }
            /* FASE 2: Permanece visible */
            55% {
                opacity: 1;
                transform: translateX(0) rotate(0deg);
            }
            /* FASE 3: Sale corriendo */
            57.1% {
                opacity: 1;
                transform: translateX(10px) rotate(3deg);
            }
            58.5% {
                opacity: 0;
                transform: translateX(-80px) rotate(-10deg);
            }
            /* FASE 4: Permanece invisible */
            100% {
                opacity: 0;
                transform: translateX(-80px) rotate(-10deg);
            }
        }
        /* ===== FIN: CSS ACTUALIZADO PARA ANIMACIÓN ===== */

    </style>
</head>
<body class="p-4 sm:p-8 flex items-start justify-center min-h-screen pt-10">

    <!-- Contenedor principal de la aplicación -->
    <div class="w-full container-full bg-gray-800 text-gray-200 p-4 rounded-3xl shadow-xl relative no-print">
        
        <!-- Contenedor del encabezado -->
        <!-- Las clases 'flex-col-reverse' y 'sm:flex-row' hacen que el nombre del cliente se mueva debajo de los botones en móviles -->
        <div class="flex flex-col-reverse sm:flex-row sm:justify-between sm:items-center mb-4">
            
            <!-- Campo de "Nombre del cliente" -->
            <div class="w-full mt-4 sm:mt-0">
                <h2 class="text-lg font-black text-gray-300 mb-1">INGRESAR NOMBRE.. </h2>
                <div class="relative">
                    <input type="text" id="clientNameInput" placeholder="AQUI..."
                           class="w-full px-4 py-2 rounded-xl border bg-gray-700 border-gray-600 text-gray-200 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-300 pl-10 text-sm">
                    <!-- Icono de persona para el campo de entrada -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                </div>
            </div>
            
            <!-- Botones de acción (imprimir, QR, escanear) -->
            <div class="flex space-x-2 w-full sm:w-auto justify-end">
                <button id="printButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-full shadow-lg transition duration-300 transform hover:scale-105">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zM9 9V5a2 2 0 012-2h2a2 2 0 012 2v4" />
                    </svg>
                </button>
                <button id="generateQrButton" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-full shadow-lg transition duration-300 transform hover:scale-105">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                    </svg>
                </button>
                <button id="scanButton" class="bg-gray-600 hover:bg-gray-700 text-gray-200 font-bold py-2 px-4 rounded-full shadow-lg transition duration-300 transform hover:scale-105">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                    </svg>
                </button>
                <!-- Nuevo botón de Opciones -->
                <button id="optionsButton" class="bg-gray-900 hover:bg-black text-white font-bold py-2 px-4 rounded-full shadow-lg transition duration-300 transform hover:scale-105">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- Campo de escáner de código QR (oculto por defecto) -->
        <div id="scannerInputContainer" class="mb-4 hidden">
            <input type="text" id="scannerInput" placeholder="Escanea el código aquí..."
                   class="w-full px-3 py-2 rounded-2xl border bg-gray-700 border-gray-600 text-gray-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-300">
        </div>

        <!-- Campo de búsqueda -->
        <div class="mb-4">
            <input type="text" id="searchInput" placeholder="Buscar productos..."
                   class="w-full px-3 py-2 rounded-2xl border bg-gray-700 border-gray-600 text-gray-200 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-300">
        </div>
        
        <!-- Contenedor para la lista de productos filtrados -->
        <div id="productList" class="space-y-2 mb-6">
            <!-- La lista de productos se renderizará aquí dinámicamente -->
        </div>

        <!-- Lista de productos agregados -->
        <div id="addedProductsList" class="space-y-2 relative max-h-64 overflow-y-auto">
            <h3 class="text-lg font-semibold text-gray-300">Productos Agregados:</h3>
            <!-- Los productos agregados se renderizarán aquí -->
        </div>

    </div>
    
    <!-- Ventana modal para la calculadora -->
    <div id="calculatorModal" class="modal no-print">
        <div class="modal-content mt-20 sm:mt-0">
            <div class="flex justify-between items-center mb-4">
                <h2 id="calculatorTitle" class="text-xl font-bold text-gray-200"></h2>
                <button id="closeCalculatorButton" class="text-gray-400 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <!-- Campo de entrada de la calculadora, ahora editable -->
            <div class="mb-4">
                <input type="text" id="calculatorInput" class="w-full text-right text-3xl font-bold p-4 bg-gray-700 text-gray-200 rounded-xl focus:outline-none" inputmode="none">
            </div>

            <!-- Botones de la calculadora, reorganizados según la imagen -->
            <div class="calculator-grid">
                <div class="calculator-button" data-value="7">7</div>
                <div class="calculator-button" data-value="8">8</div>
                <div class="calculator-button" data-value="9">9</div>
                <div class="calculator-button operator bg-red-600 hover:bg-red-700 text-white" data-value="C">C</div>

                <div class="calculator-button" data-value="4">4</div>
                <div class="calculator-button" data-value="5">5</div>
                <div class="calculator-button" data-value="6">6</div>
                <div class="calculator-button" data-value=".">.</div>

                <div class="calculator-button" data-value="1">1</div>
                <div class="calculator-button" data-value="2">2</div>
                <div class="calculator-button" data-value="3">3</div>
                <div id="emptySpacer" class="hidden sm:block"></div> <!-- Espacio para alinear el botón de aceptar -->
                <button id="acceptButton" class="calculator-accept-button bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-full">Añadir</button>

                <div class="calculator-button" data-value="0">0</div>
            </div>
        </div>
    </div>

    <!-- Nueva mini-modal para seleccionar la unidad -->
    <div id="unitModal" class="modal no-print">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4">Selecciona la Unidad</h2>
            <p id="unitModalProduct" class="mb-4"></p>
            <div id="unitOptions" class="flex flex-col space-y-4">
                <button id="selectKgButton" class="unit-button">KG</button>
                <button id="selectGramosButton" class="unit-button">Gramos</button>
                <button id="selectBsButton" class="unit-button">Bs.</button>
                <button id="selectLonjaButton" class="unit-button">Und/Lonjas</button>
            </div>
            <button id="closeUnitModal" class="text-gray-400 hover:text-white mt-4">Cerrar</button>
        </div>
    </div>
    
    <!-- Modal para mostrar el código QR -->
    <div id="qrModal" class="modal no-print">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-200">Código QR de la Lista</h2>
                <button id="closeQrModal" class="text-gray-400 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div id="qrcode" class="flex justify-center bg-white p-4 rounded-lg"></div> <!-- Fondo blanco para el QR -->
        </div>
    </div>

    <!-- Nueva modal para las Opciones -->
    <div id="optionsModal" class="modal no-print">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-100">Opciones</h2>
                <button id="closeOptionsModal" class="text-gray-400 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="space-y-4">
                <div class="bg-gray-900 p-3 rounded-lg">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold text-gray-300">Tickets Impresos:</span>
                        <button id="editCounterButton" class="text-gray-400 hover:text-indigo-400 transition-colors duration-200 p-1 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                                <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                    <div id="printCounterDisplay" class="digital-counter">0</div>
                </div>
                <button id="resetCounterButton" class="option-button w-full justify-center bg-red-600 hover:bg-red-700 text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.899 2.186l-1.414 1.414A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm12 8a1 1 0 011-1h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.899-2.186l1.414-1.414A5.002 5.002 0 0014.001 13H11a1 1 0 110 2h5z" clip-rule="evenodd" />
                    </svg>
                    Reiniciar Contador
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmación de Impresión -->
    <div id="confirmationModal" class="modal no-print">
        <div class="modal-content text-center p-8">
            <h2 class="text-2xl font-bold mb-4 text-gray-200">Confirmar Impresión</h2>
            <p class="text-lg text-gray-400 mb-8">¿Está seguro de que desea imprimir el ticket?</p>
            <div class="flex justify-center space-x-4">
                <button id="confirmPrintButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-xl shadow-lg transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-400">
                    Confirmar (Enter)
                </button>
                <button id="cancelPrintButton" class="bg-gray-600 hover:bg-gray-700 text-gray-200 font-bold py-3 px-8 rounded-xl shadow-lg transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-500">
                    Cancelar (Esc)
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmación de Reseteo -->
    <div id="resetConfirmModal" class="modal no-print">
        <div class="modal-content text-center p-8 max-w-sm">
            <h2 class="text-2xl font-bold mb-4 text-gray-200">¿Estás seguro?</h2>
            <p class="text-gray-400 mb-8">Esta acción reiniciará el contador de tickets a cero.</p>
            <div class="flex justify-center space-x-4">
                <button id="confirmResetButton" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition duration-300">
                    Sí, reiniciar
                </button>
                <button id="cancelResetButton" class="bg-gray-600 hover:bg-gray-700 text-gray-200 font-bold py-3 px-6 rounded-xl shadow-lg transition duration-300">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para Restaurar Contador -->
    <div id="restoreModal" class="modal no-print">
        <div class="modal-content text-center p-8 max-w-sm">
            <h2 class="text-2xl font-bold mb-4 text-gray-200">Restaurar Contador</h2>
            <p class="text-gray-400 mb-6">Introduce el número en el que quedó el contador.</p>
            <input type="number" id="restoreInput" class="w-full text-center text-2xl font-bold p-3 bg-gray-700 text-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 mb-6" placeholder="0">
            <div class="flex justify-center space-x-4">
                <button id="confirmRestoreButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-xl shadow-lg transition duration-300 transform hover:scale-105">
                    Guardar
                </button>
                <button id="cancelRestoreButton" class="bg-gray-600 hover:bg-gray-700 text-gray-200 font-bold py-3 px-8 rounded-xl shadow-lg transition duration-300 transform hover:scale-105">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Contenedor solo visible al imprimir -->
    <div id="printOnlyContent">
        <div class="text-center mb-4">
           
            <!-- Contenedor del nombre del cliente con el contador de impresiones -->
            <h2 id="printClientName" class="text-lg font-bold text-gray-900 mt-2"></h2>
        </div>
        <div id="printProductsList" class="space-y-2">
            <!-- Los productos se agregarán aquí para imprimir -->
        </div>
    </div>


    <script>
        // Array de objetos con la lista de productos y sus unidades.
        let products = [
            { name: "HUEVOS 1/2 ", unit: "UND" },
            { name: "CASABE", unit: "UND" },
            { name: "CHICHA GUARALAC 400GM", unit: "UND" },
            { name: "CHORIZO AHUMADO", unit: "KG" },
            { name: "CHULETA", unit: "KG" },
            { name: "CREMA DON EUSTOQUIO 500 GR", unit: "UND" },
            { name: "DIABLITO PLUMROSE", unit: "UND" },
            { name: "DULCE DE LECHE", unit: "UND" },
            { name: "GELATINA ARCOIRIS", unit: "UND" },
            { name: "GELATINA ARCOIRIS GRANDE", unit: "UND" },
            { name: "HELADO CHOCO MANI", unit: "UND" },
            { name: "HELADO CHOCO MANTECADO", unit: "UND" },
            { name: "HELADO CHOCO MOROCHO", unit: "UND" },
            { name: "HELADO CONO CHICLE", unit: "UND" },
            { name: "HELADO EXOTICO", unit: "UND" },
            { name: "HELADO MAX POLET", unit: "UND" },
            { name: "HELADO POLET FERRERO", unit: "UND" },
            { name: "HELADO SUPER CONO", unit: "UND" },
            { name: "HELADO TINITA ", unit: "UND" },
            { name: "HELADOS FRESS", unit: "UND" },
            { name: "HUESO AHUMADO", unit: "KG" },
            { name: "JAMON AHUMADO", unit: "KG" },
            { name: "JAMON AREPERO", unit: "KG" },
            { name: "JAMON DE PAVO", unit: "KG" },
            { name: "JAMON ESPALDA ORST", unit: "KG" },
            { name: "JAMON ESPALDA VIGOR", unit: "KG" },
            { name: "JAMON PIERNA ARICHUNA", unit: "KG" },
            { name: "JAMON PIERNA FIESTA", unit: "KG" },
            { name: "JUGO GUARALAC 1.5ML", unit: "UND" },
            { name: "JUGO GUARALAC 400CC", unit: "UND" },
            { name: "JUGO GUARALAC 900CC", unit: "UND" },
            { name: "JUGO JUSTY 1.5L", unit: "UND" },
            { name: "LECHE PURISIMA COMPLETA", unit: "UND" },
            { name: "LECHE PURISIMA DESCREMADA", unit: "UND" },
            { name: "LECHE PURISIMA DESLACTOSADA", unit: "UND" },
            { name: "LECHE SAN SIMON", unit: "UND" },
            { name: "MARQUESAS", unit: "UND" },
            { name: "MASA GRANDE", unit: "UND" },
            { name: "MASAS PEQUEÑA", unit: "UND" },
            { name: "MAX POÑLET WHITE FERRERO", unit: "UND" },
            { name: "MINI SALCHICHAS FIESTA", unit: "UND" },
            { name: "MORTADELA ALIBAL 1/2KG", unit: "UND" },
            { name: "MORTADELA ALIBAL DE 1KG", unit: "UND" },
            { name: "MORTADELA ALPRO 400G", unit: "UND" },
            { name: "MORTADELA ALPRO 900G", unit: "UND" },
            { name: "MORTADELA ARICHUNA", unit: "UND" },
            { name: "MORTADELA BOLGNA 1/2KG", unit: "UND" },
            { name: "MORTADELA CARACAS 900G", unit: "KG" },
            { name: "MORTADELA ESPECIAL", unit: "KG" },
            { name: "MORTADELA EXTRA", unit: "KG" },
            { name: "MORTADELA PLUMROSE 1KG", unit: "UND" },
            { name: "MORTADELA PUNTA DEL MONTE 1/2KG", unit: "UND" },
            { name: "MORTADELA PUNTA DEL MONTE DE 1KG", unit: "UND" },
            { name: "MORTADELA TAPARA", unit: "KG" },
            { name: "NATILLA GUARALAC", unit: "UND" },
            { name: "NATILLA VEGA", unit: "UND" },
            { name: "PAN ARABE", unit: "UND" },
            { name: "PAN DE SANDWICH INTEGRAL", unit: "UND" },
            { name: "PAN DE SANDWICH NORMAL", unit: "UND" },
            { name: "QUESILLO ARCOIRIS", unit: "UND" },
            { name: "QUESO DE CABRA", unit: "KG" },
            { name: "QUESO AMARILLO", unit: "KG" },
            { name: "QUESO BLANCO", unit: "KG" },
            { name: "QUESO CREMA DE CABRA", unit: "UND" },
            { name: "QUESO CRINEJA", unit: "KG" },
            { name: "QUESO DE AÑO POTE", unit: "UND" },
            { name: "QUESO DE MANO POTE VERANO", unit: "UND" },
            { name: "QUESO GUAYANEZ", unit: "KG" },
            { name: "QUESO MOZZARELLA", unit: "KG" },
            { name: "QUESO MOZZARELLA PIEZA", unit: "KG" },
            { name: "QUESO PAISA", unit: "KG" },
            { name: "QUESO PECORINO", unit: "KG" },
            { name: "QUESO RAYADO", unit: "KG" },
            { name: "QUESO REQUESON", unit: "KG" },
            { name: "RECORTE CHULETA-TOCINETA", unit: "KG" },
            { name: "RECORTE VARIOS", unit: "KG" },
            { name: "REFRESCO GLUP 2L", unit: "UND" },
            { name: "REFRESCO PEPSI 1.5 LT", unit: "KG" },
            { name: "RICOTA CABRA BARAGUA", unit: "UND" },
            { name: "RICOTA DE CABRA", unit: "KG" },
            { name: "RICOTA POTE VERANO", unit: "UND" },
            { name: "SALCHICA POLACA", unit: "KG" },
            { name: "SALCHICHA DE POLLO ALPRO", unit: "KG" },
            { name: "SUERO GUARALAC", unit: "UND" },
            { name: "SUERO KASERO 850 ML", unit: "UND" },
            { name: "SUERO PICANTE", unit: "UND" },
            { name: "SUERO PICANTE PEQUE", unit: "UND" },
            { name: "SUERO VEGA 800ML", unit: "UND" },
            { name: "TOCINETA", unit: "KG" },
            { name: "YOGUR ARCOIRIS GRAND", unit: "UND" },
            { name: "YOGUR ARCOIRIS PEQ", unit: "UND" },
            { name: "YOGURT GUARALAC 400 ML", unit: "UND" },
            { name: "YOGURT NATURAL", unit: "UND" }
        ];

        // Referencias a los elementos del DOM
        const clientNameInput = document.getElementById('clientNameInput');
        const searchInput = document.getElementById('searchInput');
        const productList = document.getElementById('productList');
        const addedProductsList = document.getElementById('addedProductsList');
        const printButton = document.getElementById('printButton');
        const generateQrButton = document.getElementById('generateQrButton');
        const scanButton = document.getElementById('scanButton');
        const scannerInputContainer = document.getElementById('scannerInputContainer');
        const scannerInput = document.getElementById('scannerInput');
        
        // Elementos del DOM para la calculadora
        const calculatorModal = document.getElementById('calculatorModal');
        const calculatorTitle = document.getElementById('calculatorTitle');
        const calculatorInput = document.getElementById('calculatorInput');
        const calculatorButtons = document.querySelectorAll('#calculatorModal .calculator-button');
        const closeCalculatorButton = document.getElementById('closeCalculatorButton');
        const acceptButton = document.getElementById('acceptButton');
        
        // Elementos del DOM para la mini-modal de unidades
        const unitModal = document.getElementById('unitModal');
        const unitModalProduct = document.getElementById('unitModalProduct');
        const selectKgButton = document.getElementById('selectKgButton');
        const selectGramosButton = document.getElementById('selectGramosButton');
        const selectBsButton = document.getElementById('selectBsButton');
        const selectLonjaButton = document.getElementById('selectLonjaButton');
        const closeUnitModal = document.getElementById('closeUnitModal');
        const unitOptions = [selectKgButton, selectGramosButton, selectBsButton, selectLonjaButton];
        let selectedUnitIndex = 0;
        
        // Elementos del DOM para el QR
        const qrModal = document.getElementById('qrModal');
        const closeQrModal = document.getElementById('closeQrModal');
        const qrcodeContainer = document.getElementById('qrcode');

        // Elementos de la nueva modal de opciones
        const optionsButton = document.getElementById('optionsButton');
        const optionsModal = document.getElementById('optionsModal');
        const closeOptionsModal = document.getElementById('closeOptionsModal');
        const printCounterDisplay = document.getElementById('printCounterDisplay');
        const resetCounterButton = document.getElementById('resetCounterButton');

        // Elementos del DOM para la impresión
        const printOnlyContent = document.getElementById('printOnlyContent');
        const printProductsList = document.getElementById('printProductsList');
        const printClientName = document.getElementById('printClientName');
        
        // Elementos para el modal de confirmación
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmPrintButton = document.getElementById('confirmPrintButton');
        const cancelPrintButton = document.getElementById('cancelPrintButton');

        // Nuevos elementos para restaurar y confirmar reseteo
        const editCounterButton = document.getElementById('editCounterButton');
        const restoreModal = document.getElementById('restoreModal');
        const restoreInput = document.getElementById('restoreInput');
        const confirmRestoreButton = document.getElementById('confirmRestoreButton');
        const cancelRestoreButton = document.getElementById('cancelRestoreButton');
        const resetConfirmModal = document.getElementById('resetConfirmModal');
        const confirmResetButton = document.getElementById('confirmResetButton');
        const cancelResetButton = document.getElementById('cancelResetButton');

        // Estado de la aplicación
        let filteredProducts = [];
        let selectedProductIndex = -1;
        let addedProducts = [];
        let currentProduct = null;
        let currentUnit = null;
        let currentNumericValue = 0;

        /**
         * Abre el modal de confirmación para imprimir.
         */
        function openConfirmationModal() {
            if (addedProducts.length > 0) {
                confirmationModal.style.display = 'flex';
                confirmPrintButton.focus(); // Pone el foco en el botón de confirmar
            }
        }

        /**
         * Cierra el modal de confirmación.
         */
        function closeConfirmationModal() {
            confirmationModal.style.display = 'none';
            searchInput.focus(); // Devuelve el foco al campo de búsqueda
        }

        /**
         * Renderiza la lista de productos en el DOM.
         * @param {Array<Object>} list La lista de productos a mostrar.
         * @param {number} selectedIndex El índice del producto resaltado. */
         
        function renderProducts(list, selectedIndex) {
            // Limpia la lista actual
            productList.innerHTML = '';
            
            // Si la lista está vacía, muestra un mensaje
            if (list.length === 0 && searchInput.value.trim().length > 0) {
                productList.innerHTML = '<p class="text-center text-gray-400 italic">No se encontraron productos.</p>';
                return;
            }
            if (searchInput.value.trim().length === 0) {
                 productList.innerHTML = '<p class="text-center text-gray-400 italic font-bold">Escribe para buscar un producto...</p>';
                return;
            }

            // Crea un fragmento de documento para un rendimiento eficiente
            const fragment = document.createDocumentFragment();

            list.forEach((product, index) => {
                const productElement = document.createElement('div');
                productElement.className = 'flex justify-between items-center bg-gray-700 p-3 rounded-xl shadow-sm transition-transform duration-200 transform hover:scale-105 hover:shadow-md cursor-pointer';
                
                // Agrega la clase de resaltado si el índice coincide
                if (index === selectedIndex) {
                    productElement.classList.add('highlighted');
                }

                // Contenedor para el nombre y la unidad del producto
                const productInfoContainer = document.createElement('div');
                productInfoContainer.className = 'flex items-center space-x-2';

                // Nombre del producto
                const nameSpan = document.createElement('span');
                nameSpan.className = 'text-gray-200 text-sm font-medium capitalize truncate';
                nameSpan.textContent = product.name.toLowerCase();
                
                // Unidad del producto
                const unitSpan = document.createElement('span');
                unitSpan.className = 'text-xs text-gray-400 font-semibold';
                unitSpan.textContent = `(${product.unit})`; // Muestra la unidad entre paréntesis

                productInfoContainer.appendChild(nameSpan);
                productInfoContainer.appendChild(unitSpan);

                productElement.appendChild(productInfoContainer);

                // Agrega un evento de clic para seleccionar el producto
                productElement.addEventListener('click', () => {
                    openCalculator(product);
                });

                fragment.appendChild(productElement);
            });

            // Agrega todos los elementos a la vez
            productList.appendChild(fragment);

            // Asegura que el elemento resaltado esté visible en la pantalla
            if (selectedIndex !== -1) {
                const highlightedElement = productList.children[selectedIndex];
                if (highlightedElement) {
                    // Usa scrollIntoView para desplazar el elemento a la vista
                    highlightedElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }
        }

        /**
         * Renderiza la lista de productos agregados en el DOM.
         */
        function renderAddedProducts() {
            addedProductsList.innerHTML = '<h3 class="text-lg font-semibold text-gray-300">Productos Agregados:</h3>';
            
            if (addedProducts.length === 0) {
                addedProductsList.innerHTML += '<p class="text-center text-gray-400 italic font-bold">No hay productos agregados.</p>';
                return;
            }

            const fragment = document.createDocumentFragment();

            addedProducts.forEach((product, index) => {
                const productElement = document.createElement('div');
                // Usamos flexbox para alinear el nombre a la izquierda y la cantidad a la derecha
                productElement.className = 'flex justify-between items-center bg-indigo-900 bg-opacity-50 p-3 rounded-xl shadow-sm';
                
                // Contenedor para el nombre del producto
                const productInfoContainer = document.createElement('div');
                productInfoContainer.className = 'flex items-center space-x-2';
                
                // Nombre del producto con la fuente Blinker
                const nameSpan = document.createElement('span');
                nameSpan.className = 'text-indigo-200 text-sm font-bold capitalize truncate'; 
                nameSpan.textContent = product.name.toLowerCase();
                
                productInfoContainer.appendChild(nameSpan);
                
                // Cantidad con la unidad
                const quantitySpan = document.createElement('span');
                quantitySpan.className = 'text-indigo-300 text-xs font-bold'; 
                if (product.quantity) {
                   quantitySpan.textContent = `(${product.quantity} ${product.unit})`;
                }

                // Contenedor para el botón de eliminar
                const actionContainer = document.createElement('div');
                actionContainer.className = 'flex items-center space-x-2';

                // Botón de eliminar con el ícono SVG
                const deleteButton = document.createElement('button');
                deleteButton.className = 'delete-button text-red-400 hover:text-red-500';
                deleteButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                    </svg>
                `;
                deleteButton.addEventListener('click', () => {
                    removeProduct(index);
                });

                actionContainer.appendChild(deleteButton);
                actionContainer.appendChild(quantitySpan);

                productElement.appendChild(productInfoContainer);
                productElement.appendChild(actionContainer);
                fragment.appendChild(productElement);
            });

            addedProductsList.appendChild(fragment);
        }

        /**
         * Agrega un producto a la lista de productos agregados.
         * @param {Object} product El producto a agregar.
         */
        function addProduct(product) {
            addedProducts.push(product);
            renderAddedProducts();
            searchInput.value = '';
            // Después de agregar, volvemos a filtrar para actualizar la lista de búsqueda
            filterProductsAndRender('');
        }
        
        /**
         * Elimina un producto de la lista de productos agregados.
         * @param {number} index El índice del producto a eliminar.
         */
        function removeProduct(index) {
            addedProducts.splice(index, 1);
            renderAddedProducts();
        }

        /**
         * Abre la mini-modal para seleccionar la unidad.
         */
        function openUnitModal() {
            const numericValue = parseFloat(calculatorInput.value);
            if (!isNaN(numericValue) && numericValue > 0) {
                // Guarda el valor numérico de la calculadora antes de abrir el modal de unidad
                currentNumericValue = numericValue;
                unitModalProduct.textContent = `Seleccionaste: ${currentProduct.name.toLowerCase()}`;
                unitModal.style.display = 'flex';
                // Resalta la primera opción por defecto
                selectedUnitIndex = 0;
                highlightSelectedUnit();
                // Añade el event listener para las teclas
                document.addEventListener('keydown', handleUnitKeydown);
            }
        }

        /**
         * Cierra la mini-modal de unidades.
         */
        function closeUnitModalFunction() {
            unitModal.style.display = 'none';
            // Elimina el event listener al cerrar el modal
            document.removeEventListener('keydown', handleUnitKeydown);
        }

        /**
         * Resalta el botón de unidad seleccionado.
         */
        function highlightSelectedUnit() {
            unitOptions.forEach((button, index) => {
                button.classList.remove('unit-option-highlighted');
                if (index === selectedUnitIndex) {
                    button.classList.add('unit-option-highlighted');
                }
            });
        }
        
        /**
         * Manejador de eventos para las teclas en el modal de unidad.
         */
        function handleUnitKeydown(e) {
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedUnitIndex = (selectedUnitIndex + 1) % unitOptions.length;
                highlightSelectedUnit();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedUnitIndex = (selectedUnitIndex - 1 + unitOptions.length) % unitOptions.length;
                highlightSelectedUnit();
            } else if (e.key === 'Enter') {
                e.preventDefault();
                unitOptions[selectedUnitIndex].click();
            }
        }

        // Manejadores de eventos para los botones de unidad
        selectKgButton.addEventListener('click', () => handleUnitSelection('KG'));
        selectGramosButton.addEventListener('click', () => handleUnitSelection('Gramos'));
        selectBsButton.addEventListener('click', () => handleUnitSelection('Bs.'));
        selectLonjaButton.addEventListener('click', () => handleUnitSelection('Und/Lonjas'));
        closeUnitModal.addEventListener('click', closeUnitModalFunction);

        /**
         * Manejador para los botones de unidad.
         * @param {string} unit La unidad seleccionada ('KG', 'Gramos', 'Bs.', 'Lonjas').
         */
        function handleUnitSelection(unit) {
            currentUnit = unit;
            closeUnitModalFunction();
            
            let quantity = currentNumericValue;
            
            // La lógica para la unidad de 'Gramos' no necesita conversión aquí, ya que el valor se almacena como está
            if (unit === 'Gramos') {
                quantity = currentNumericValue;
            } else if (unit === 'Bs.') {
                quantity = currentNumericValue;
            } else if (unit === 'Und/Lonjas') { // Maneja la nueva unidad "Lonjas"
                quantity = currentNumericValue;
            } else if (unit === 'KG') {
                // Si el usuario ingresó gramos y luego selecciona KG, convertir a kg
                // Pero en esta lógica el valor de la calculadora es el que se usa directamente
                quantity = currentNumericValue;
            }

            const productWithQuantity = { ...currentProduct, quantity: quantity, unit: unit };
            addProduct(productWithQuantity);
            // Vuelve al inicio
            searchInput.focus();
        }
        

        /**
         * Abre la ventana modal de la calculadora.
         * @param {Object} product El producto para el que se calculará la cantidad.
         */
          function openCalculator(product) {
            currentProduct = product;
            currentNumericValue = 0;
            calculatorTitle.textContent = product.name;
            calculatorInput.value = '1'; // Limpiar el input
            calculatorModal.style.display = 'flex';
            // Pone el foco en el campo de entrada sin seleccionar el texto
            calculatorInput.focus();
             calculatorInput.select();
        } 

        /**
         * Cierra la ventana modal de la calculadora.
         */
        function closeCalculator() {
            calculatorModal.style.display = 'none';
        }

        /**
         * Acepta la cantidad ingresada y agrega el producto a la lista.
         */
        function acceptQuantity() {
            const numericValue = parseFloat(calculatorInput.value);

            if (isNaN(numericValue) || numericValue <= 0) {
                // Si el valor no es válido, no hacemos nada.
                return;
            }
            
            // Lógica para agregar productos con la unidad "UND" directamente
            if (currentProduct.unit === 'UND') {
                const productWithQuantity = {
                    ...currentProduct,
                    quantity: numericValue,
                    unit: 'UND' // Mantiene la unidad original
                };
                addProduct(productWithQuantity);
                closeCalculator();
                searchInput.focus();
            } else {
                // Para el resto de productos, abre el modal de unidad
                closeCalculator();
                openUnitModal();
            }
        }
        
        /**
         * Función para filtrar productos y renderizar la lista.
         * @param {string} searchTerm El término de búsqueda.
         */
        function filterProductsAndRender(searchTerm) {
            const numericSearch = parseInt(searchTerm);
            
            if (!isNaN(numericSearch)) {
                // Si el término de búsqueda es un número, busca por índice
                if (numericSearch > 0 && numericSearch <= products.length) {
                    filteredProducts = [products[numericSearch - 1]];
                    // Si se encuentra un producto, se resalta
                    selectedProductIndex = 0;
                } else {
                    filteredProducts = [];
                    selectedProductIndex = -1;
                }
            } else {
                // Si no es un número, busca por nombre
                filteredProducts = products.filter(product => product.name.toLowerCase().includes(searchTerm.toLowerCase()));
                selectedProductIndex = -1;
            }

            if (searchTerm.length > 0) {
                renderProducts(filteredProducts, selectedProductIndex);
            } else {
                productList.innerHTML = '<p class="text-center text-gray-400 italic font-bold">Escribe para buscar un producto...</p>';
                filteredProducts = [];
                selectedProductIndex = -1;
            }
              
        }
        
        /**
         * Función para manejar la entrada de teclado.
         */
        function handleKeyboardInput(e) {
            const key = e.key;
            
            // Si la barra de búsqueda está en foco y no hay un modal abierto
            if (document.activeElement === searchInput && calculatorModal.style.display !== 'flex') {
                if (e.key === 'ArrowDown' && filteredProducts.length > 0) {
                    e.preventDefault();
                    selectedProductIndex = (selectedProductIndex + 1) % filteredProducts.length;
                    renderProducts(filteredProducts, selectedProductIndex);
                } else if (e.key === 'ArrowUp' && filteredProducts.length > 0) {
                    e.preventDefault();
                    selectedProductIndex = (selectedProductIndex - 1 + filteredProducts.length) % filteredProducts.length;
                    renderProducts(filteredProducts, selectedProductIndex);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (selectedProductIndex >= 0 && filteredProducts.length > 0) {
                        const product = filteredProducts[selectedProductIndex];
                        openCalculator(product);
                    } else if (filteredProducts.length === 0 && searchInput.value.trim() !== '') {
                        // Si no hay productos encontrados y se presiona Enter, limpiar el campo.
                        searchInput.value = '';
                        filterProductsAndRender(''); // Volver a renderizar para mostrar el mensaje inicial.
                    }
                }
            } else if (calculatorModal.style.display === 'flex') {
                // Si el modal de la calculadora está abierto, procesa solo las teclas de control
                if (key === 'Enter') {
                    e.preventDefault();
                    acceptQuantity();
                } else if (key === 'Escape') {
                    e.preventDefault();
                    closeCalculator();
                } else if (key === 'Backspace' || key === 'Delete') {
                    e.preventDefault();
                    calculatorInput.value = calculatorInput.value.slice(0, -1);
                }
            }
        }
        // Agrega el manejador de eventos del teclado al documento
        document.addEventListener('keydown', handleKeyboardInput);

        // Manejador de eventos para el campo de nombre del cliente
        clientNameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); // Evita el comportamiento por defecto de 'Enter'
                searchInput.focus(); // Mueve el foco al campo de búsqueda
            }
        });

        // Lógica de la calculadora con los botones
        calculatorButtons.forEach(button => {
            button.addEventListener('click', () => {
                const value = button.dataset.value;
                let currentInputValue = calculatorInput.value;

                if (value === 'C') {
                    currentInputValue = '';
                } else if (value === '.') {
                    if (!currentInputValue.includes('.')) {
                        currentInputValue += '.';
                    }
                } else {
                    currentInputValue += value;
                }
                
                calculatorInput.value = currentInputValue;
                // Después de un clic, el foco permanece en el input.
                // Aseguramos que el cursor esté al final del texto.
                calculatorInput.focus();
                calculatorInput.selectionStart = calculatorInput.selectionEnd = calculatorInput.value.length;
            });
        });

        // Manejador del botón "Añadir" de la calculadora
        acceptButton.addEventListener('click', acceptQuantity);

        // Manejador del botón de cerrar la modal de la calculadora
        closeCalculatorButton.addEventListener('click', closeCalculator);

        // Manejador de eventos para el campo de búsqueda
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase().trim();
            // Restablece el índice de selección al filtrar
            filterProductsAndRender(searchTerm);
        });

        // Manejador del botón de cerrar el modal del QR
        closeQrModal.addEventListener('click', () => {
            qrModal.style.display = 'none';
        });
        
        /**
         * Prepara y muestra la lista para imprimir.
         */
        function preparePrint() {
            // Limpia el contenido de impresión previo
            printProductsList.innerHTML = '';

            // Obtiene el contador de impresiones del localStorage
            let printCount = parseInt(localStorage.getItem('printCount')) || 0;

            // Actualiza el nombre del cliente con el contador
            const clientName = clientNameInput.value ? `${clientNameInput.value}` : '';
            printClientName.textContent = `${clientName} (#${printCount})`;

            // Renderiza la lista de productos para la impresión
            addedProducts.forEach((product) => {
                const productElement = document.createElement('div');
                productElement.className = 'flex justify-between items-center print-list-item print-content';
                
                const nameSpan = document.createElement('div');
                nameSpan.className = 'text-gray-900 text-sm font-extrabold capitalize truncate';
                nameSpan.textContent = product.name.toLowerCase();
                
                const quantitySpan = document.createElement('div');
                quantitySpan.className = 'text-gray-900 text-xs font-bold';
                
                               
                if (product.quantity) {
                    const quantity = (product.unit === 'KG' || product.unit === 'Gramos') ? parseFloat(product.quantity.toFixed(3)) : product.quantity;
                    quantitySpan.textContent = `${quantity} ${product.unit}`;
                }

                productElement.appendChild(nameSpan);
                productElement.appendChild(quantitySpan);
                printProductsList.appendChild(productElement);
            });
            
        }
       
        /**
         * Función para imprimir la lista de productos agregados.
         */
         function printProducts() {
            // Incrementa el contador antes de imprimir
            let printCount = parseInt(localStorage.getItem('printCount')) || 0;
            printCount++;
            localStorage.setItem('printCount', printCount);

            // Prepara el contenido para impresión
            preparePrint();

            // Llama a la función de impresión del navegador
            window.print();

            // === NUEVO CAMBIO: Usar setTimeout para garantizar la ejecución después de imprimir ===
            // Esto da tiempo al navegador para cerrar el diálogo de impresión antes de mover el foco.
            setTimeout(() => {
                // Limpia los campos
                searchInput.value = '';
                addedProducts = [];
                renderAddedProducts();

                // Coloca el foco en el campo del nombre del cliente y lo selecciona
                clientNameInput.value = '';
                clientNameInput.focus();
                clientNameInput.select();
            }, 100); // Un pequeño retraso es suficiente
        }

        // Manejador de eventos para el botón de imprimir
        printButton.addEventListener('click', () => {
             if (addedProducts.length > 0) {
                openConfirmationModal();
            }
        });
        
        /**
         * Actualiza el contador de impresiones visible en la modal.
         */
        function updatePrintCountDisplay() {
            const printCount = localStorage.getItem('printCount') || '0';
            printCounterDisplay.textContent = printCount;
            
            // Ajusta dinámicamente el tamaño de la fuente para evitar el desbordamiento.
            const countLength = printCount.length;
            if (countLength > 3) {
                // Reduce el tamaño de la fuente a medida que aumenta el número de dígitos.
                const newSize = 2.5 - (countLength - 3) * 0.5;
                printCounterDisplay.style.fontSize = `${Math.max(newSize, 1.2)}rem`; // Se asegura un tamaño mínimo.
            } else {
                // Restablece el tamaño de fuente predeterminado.
                printCounterDisplay.style.fontSize = '2.5rem';
            }
        }

        // Manejador para el botón de Opciones
        optionsButton.addEventListener('click', () => {
            updatePrintCountDisplay();
            optionsModal.style.display = 'flex';
        });

        // Manejador para cerrar la modal de Opciones
        closeOptionsModal.addEventListener('click', () => {
            optionsModal.style.display = 'none';
        });
        
        // Manejador para el botón de reiniciar contador
        resetCounterButton.addEventListener('click', () => {
            resetConfirmModal.style.display = 'flex';
        });

        confirmResetButton.addEventListener('click', () => {
            localStorage.setItem('printCount', '0');
            updatePrintCountDisplay();
            resetConfirmModal.style.display = 'none';
        });

        cancelResetButton.addEventListener('click', () => {
            resetConfirmModal.style.display = 'none';
        });


        /**
         * Genera y muestra el código QR con la lista de productos.
         */
        function generateQrCode() {
            if (addedProducts.length === 0) return;
            // Limpia el contenido previo del QR
            qrcodeContainer.innerHTML = '';

            // Genera la cadena de texto para el QR
            let qrText = `Nombre del Cliente: ${clientNameInput.value || 'N/A'}\n\n`;
            addedProducts.forEach(product => {
                // Formatea la cantidad para eliminar decimales si es un número entero
                const formattedQuantity = Number.isInteger(product.quantity) ? product.quantity.toString() : product.quantity.toFixed(3);
                qrText += `${product.name} - ${formattedQuantity} ${product.unit}\n`;
            });
            
            // Crea una instancia de QRCode
            new QRCode(qrcodeContainer, {
                text: qrText,
                width: 256,
                height: 256,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
            
            // Muestra el modal del QR
            qrModal.style.display = 'flex';
        }
        
        // Manejador para el nuevo botón de generar QR
        generateQrButton.addEventListener('click', generateQrCode);

        // Eventos para el modal de restaurar contador
        editCounterButton.addEventListener('click', () => {
            restoreInput.value = localStorage.getItem('printCount') || 0;
            restoreModal.style.display = 'flex';
            restoreInput.select();
        });

        cancelRestoreButton.addEventListener('click', () => {
            restoreModal.style.display = 'none';
        });

        confirmRestoreButton.addEventListener('click', () => {
            const newValue = parseInt(restoreInput.value, 10);
            if (!isNaN(newValue) && newValue >= 0) {
                localStorage.setItem('printCount', newValue.toString());
                updatePrintCountDisplay();
                restoreModal.style.display = 'none';
            } else {
                restoreInput.classList.add('border-red-500', 'border-2');
                setTimeout(() => {
                    restoreInput.classList.remove('border-red-500', 'border-2');
                }, 1000);
            }
        });

        // Manejadores de eventos para el modal de confirmación
        confirmPrintButton.addEventListener('click', () => {
            printProducts();
            closeConfirmationModal();
        });

        cancelPrintButton.addEventListener('click', closeConfirmationModal);
        
        // Manejador de eventos de teclado para el modal de confirmación y la tecla F9
        document.addEventListener('keydown', (e) => {
            // Atajo para imprimir con F9
            if (e.key === 'F9') {
                e.preventDefault(); // Prevenir la acción por defecto
                if (addedProducts.length > 0) {
                    openConfirmationModal();
                }
            }

            if (confirmationModal.style.display === 'flex') {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    confirmPrintButton.click();
                } else if (e.key === 'Escape' || e.key === 'Esc') {
                    e.preventDefault();
                    cancelPrintButton.click();
                }
            } else if (restoreModal.style.display === 'flex') {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    confirmRestoreButton.click();
                } else if (e.key === 'Escape' || e.key === 'Esc') {
                    e.preventDefault();
                    cancelRestoreButton.click();
                }
            } else if (resetConfirmModal.style.display === 'flex') {
                 if (e.key === 'Enter') {
                    e.preventDefault();
                    confirmResetButton.click();
                } else if (e.key === 'Escape' || e.key === 'Esc') {
                    e.preventDefault();
                    cancelResetButton.click();
                }
            }
        });

        // Renderiza la lista completa al cargar la página
        window.onload = () => {
            renderAddedProducts();
            productList.innerHTML = '<p class="text-center text-gray-400 italic font-bold">Escribe para buscar un producto...</p>';
        };
    </script>

    <!-- ===== INICIO: HTML ACTUALIZADO PARA ANIMACIÓN ===== -->
    <div class="animated-title-container no-print">
        <span style="animation-delay: 0.1s;">C</span>
        <span style="animation-delay: 0.2s;">H</span>
        <span style="animation-delay: 0.3s;">A</span>
        <span style="animation-delay: 0.4s;">R</span>
        <span style="animation-delay: 0.5s;">C</span>
        <span style="animation-delay: 0.6s;">U</span>
        <span style="animation-delay: 0.7s;">T</span>
        <span style="animation-delay: 0.8s;">E</span>
        <span style="animation-delay: 0.9s;">R</span>
        <span style="animation-delay: 1.0s;">I</span>
        <span style="animation-delay: 1.1s;">A</span>
    </div>
    <!-- ===== FIN: HTML ACTUALIZADO PARA ANIMACIÓN ===== -->

</body>
</html>

